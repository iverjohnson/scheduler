<!doctype html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>MedKab Scheduling</title>
	
	
	<script src='codebase/dhtmlxscheduler.js' type="text/javascript" charset="utf-8"></script>
	<script src="codebase/ext/dhtmlxscheduler_limit.js" type="text/javascript" charset="utf-8"></script>
	<script src='codebase/ext/dhtmlxscheduler_timeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='codebase/ext/dhtmlxscheduler_treetimeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='codebase/ext/dhtmlxscheduler_key_nav.js' type="text/javascript" charset="utf-8"></script>
	<script src='codebase/ext/dhtmlxscheduler_collision.js' type="text/javascript" charset="utf-8"></script>
	<script src="codebase/ext/dhtmlxscheduler_tooltip.js"></script>
	<script src="codebase/ext/dhtmlxscheduler_editors.js" type="text/javascript" charset="utf-8"></script>
	<script src="codebase/ext/dhtmlxscheduler_minical.js" type="text/javascript" charset="utf-8"></script>
	<script src="codebase/dhtmlxdataprocessor_debug.js"></script>
	<script src="codebase/dhtmlx.js" type="text/javascript" charset="utf-8"></script>
	<script src="codebase/mark_complete.js" type="text/javascript" charset="utf-8"></script>
	<script src="codebase/unit_functions.js" type="text/javascript" charset="utf-8"></script>
	<link rel='stylesheet' type='text/css' href='codebase/dhtmlx.css'>
	<link rel='stylesheet' type='text/css' href='codebase/dhtmlxscheduler_flat.css'>
	
	


	
<style type="text/css" media="screen">
	html, body{
		margin:0px;
		padding:0px;
		height:100%;
		overflow:hidden;
	}	
	.schedule_title{
		font-family: "Segoe UI",Arial;
		text-align: center;
		font-size:22px;
		width:100%;
	}
	.one_line{
		white-space:nowrap;
		overflow:hidden;
		padding-top:5px; padding-left:5px;
		text-align:left !important;
	}
	.dhx_cal_event.event_200 div, .dhx_cal_event_line.event_200{
			background-color: orange !important;
			border-color: #a36800 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_200{
			color:orange !important;
		}

		.dhx_cal_event.event_201 div, .dhx_cal_event_line.event_201{
			background-color: #36BD14 !important;
			border-color: #698490 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_201{
			color:#36BD14 !important;
		}

		.dhx_cal_event.event_202 div, .dhx_cal_event_line.event_202{
			background-color: #FC5BD5 !important;
			border-color: #839595 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_202{
			color:#B82594 !important;
		}
		.dhx_cal_event.event_203 div, .dhx_cal_event_line.event_203{
			background-color: grey !important;
			border-color: #839595 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_203{
			color:#B82594 !important;
		}
		.dhx_cal_event.event_204 div, .dhx_cal_event_line.event_204{
			background-color: red !important;
			border-color: #839595 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_204{
			color:#B82594 !important;
		}
		
	.dhx_cal_event.event_complete div, .dhx_cal_event_line.event_complete{
			background-color: #7B7D7D !important;
			text-decoration: line-through !important;
			border-color: #839595 !important;
			background-image:none; !important;
		}
		.dhx_cal_event_clear.event_complete{
			color:#B82594 !important;
		}
		.pink{
			background-color:#ff9898 !important;
			}
	</style>

<script type="text/javascript" charset="utf-8">
//======================
//Create Scheduler
//======================
		
function init() {

//=====================
//Menu
//=====================

	var mainMenu;
	mainMenu = new dhtmlXMenuObject("menuID");	
	mainMenu.addNewSibling(null, 1, "Scheduling");
		mainMenu.setHref(1,"./medkab.html");
	mainMenu.addNewSibling(1, 2, "Manage Units");
		mainMenu.setHref(2,"./manage_units.html");
	mainMenu.addNewSibling(2, 3, "Manage Units Types");
		mainMenu.setHref(3,"./manage_unit_types.html");
	mainMenu.addNewSibling(3,4,"Manage Event Types");
		mainMenu.setHref(4,"./manage_event_types.html");
	
		//====================
		//Event Appearance
		//====================
		
		//event coloration
		scheduler.templates.event_class=function(start, end, event){
			var css = "";

			if(event.complete == "1"){ //changes event color if marked complete
				css += "event_complete ";}
				
				
			if(event.type){ // changes event color based on event type
				css += "event_"+event.type;}
				
			return css; // default return
		};
				
		//Set up displayed title in bar
		scheduler.templates.event_bar_text = function(start,end,event){
			var checkedBox = "";
				if(event.complete == "1"){
					checkBox ="checked";}
					else{
					checkBox="";}
			var html = "<input type='checkbox' onclick='mark_complete("+event.id+");'"+checkBox+">";
				return html+scheduler.getLabel("pickup",event.pickup) + "<br/> " + scheduler.getLabel("destination",event.destination);
		};
		
		//tooltips
		scheduler.templates.tooltip_text = function(start,end,ev){
			if (ev.pickup) {
				//var pickupCity = 
				return "<b>Pickup:</b> "+scheduler.getLabel("pickup",ev.pickup)+"<br/><b>Destination:</b> " +  scheduler.getLabel("destination",ev.destination);
			}
		};
				
		
		
		//===============
		//Configuration
		//===============	
		
		
		scheduler.locale.labels.timeline_tab = "Timeline";
		scheduler.locale.labels.section_custom="Unit";
		scheduler.config.details_on_create=true;
		scheduler.config.details_on_dblclick=true;
		scheduler.config.xml_date="%Y-%m-%d %H:%i:%s";
		scheduler.config.time_step=15;
		scheduler.config.ajax_error = "alert";
		scheduler.config.full_day = true;
		
		
		
		elements = scheduler.serverList("units");
		facilities = scheduler.serverList("facilities");
		var dstart = new Date();
		
		scheduler.createTimelineView({
			section_autoheight: true,
			name:	"timeline",
			x_unit:	"minute",
			x_date:	":%i",
			second_scale:{x_date:"%H", x_unit: "hour"}, //hours above minutes
			x_step:	15, //15 minute blocks
			x_size: 48,
			x_start: (dstart.getHours()*4)-8, //automatically forward the calendar view to now minus two hours
			x_length:5,
			y_unit: elements,
			render: "tree",
			folder_events_available: true,
			event_dy:'full',
			dy:30,
			dx:80
		});
		
		
		
		// Appointment types TODO:pull from DB
		var appointmenttype = [
			{key:200, label:'Dr. Appt'},
			{key:201, label:'Discharge'},
			{key:202, label:'OOT'},
			{key:203, label:'Cxl Shift'},
			{key:204, label:'Unavailable'},
		];
		
		scheduler.templates.timeline_scale_label = function(key, label, section){
			unit = scheduler.getSection(key);
			if(unit.oos == "0"){
			var checked = "";
			}
			else {
			var checked = "checked";
			scheduler.addMarkedTimespan({days:new Date(),zones:"fullday", css: "pink", html:"<b> OUT OF SERVICE </>", type: "dhx_time_block", sections: {timeline:key}});
			}
				var unitHtml = "<input type='checkbox' onclick='markOos("+key+");'"+checked+">";
			return label + unitHtml;
}	
			
	//===============
	//Lightbox and data
	//===============
		
		
		//Section labels	
		scheduler.locale.labels.section_pickup = "Pick-Up";
		scheduler.locale.labels.section_dropoff = "Drop-Off";
		scheduler.locale.labels.section_appttype = "Appointment Type";
		scheduler.locale.labels.section_transtime = "Tansport Time (in minutes)";
		scheduler.locale.labels.section_complete = "Completed";
		
		//lightbox setup
		scheduler.templates.lightbox_header = function(start, end, event){
			if(event.complete == "1"){
				return "Completed";
			}
			else {
			return "";
			}
		}
		scheduler.config.lightbox.sections=[	
			{name: "pickup", height:40,options:facilities, map_to: "pickup", type: "combo", image_path: "codebase/common/dhtmlxCombo/imgs/", filtering: true,  cache: true , focus: true},
			{name: "dropoff", height:40,options:facilities, map_to: "destination", type: "combo", image_path: "codebase/common/dhtmlxCombo/imgs/", filtering: true,  cache: true },
			{name:"appttype", height: 40, map_to:"type", type:"radio",options:appointmenttype},
			{name:"transtime", height: 30, map_to:"transtime", type:"textarea",options:null},
			{name:"Unit", height:23, type:"timeline", options:null , map_to:"unit_id" }, //type should be the same as name of the tab
			{name:"complete", height:23, map_to:"complete", type:"checkbox", checked_value:"1", unchecked_value:"0"},
			{name:"time", height:72, type:"time", map_to:"auto"}
		];
		
		
		
		
		//updates end_date based on transport time, rounded up to the next 15 minutes
		scheduler.attachEvent("onEventSave",function(id,ev, is_new){
			var triptime = parseInt(ev.transtime)+38;
			var minutes = (parseInt((triptime/15))+1)*15;
			return ev.end_date = scheduler.date.add(ev.start_date, minutes, 'minute');
		});
		
		
		//time blocking in calendar. TODO: Get from scheduling tool or DB
		
		/*function setUnitOffTime(id){
			
		}*/
				
		//401
		scheduler.addMarkedTimespan({days:[1,2,3,4,5], zones:[0, 6.5*60, 14.5*60, 24*60], type: "dhx_time_block", sections: {timeline:20}});
		//402
		scheduler.addMarkedTimespan({days:[0,1,2,3,6], zones:[0, 6.5*60, 14.5*60, 24*60], type: "dhx_time_block", sections: {timeline:30}});
		//403
		scheduler.addMarkedTimespan({days:[0,3,4,5,6], zones:[0, 9*60, 17*60, 24*60], type: "dhx_time_block", sections: {timeline:40}});
		//404
		scheduler.addMarkedTimespan({days:[1,2,3,4,5], zones:[0, 9*60, 17*60, 24*60], type: "dhx_time_block", sections: {timeline:50}});
		//405
		scheduler.addMarkedTimespan({days:[1,2,3,4,5], zones:[0, 10.5*60, 18.5*60, 24*60], type: "dhx_time_block", sections: {timeline:60}});
		//406
		scheduler.addMarkedTimespan({days:[0,1,2,4,6], zones:[0, 10.5*60, 18.5*60, 24*60], type: "dhx_time_block", sections: {timeline:70}});
		//407
		scheduler.addMarkedTimespan({days:[1,2,3,4,5], zones:[0, 11.5*60, 19.5*60, 24*60], type: "dhx_time_block", sections: {timeline:80}});
		//408
		scheduler.addMarkedTimespan({days:[1,2,3,4,5], zones:[0, 11.5*60, 19.5*60, 24*60], type: "dhx_time_block", sections: {timeline:90}});
		//409
		scheduler.addMarkedTimespan({days:[2,3,4,5,6], zones:[0, 11.5*60, 19.5*60, 24*60], type: "dhx_time_block", sections: {timeline:100}});
		//410
		scheduler.addMarkedTimespan({days:[0,1,2,5,6], zones:[0, 12.5*60, 20.5*60, 24*60], type: "dhx_time_block", sections: {timeline:110}});
		//411
		scheduler.addMarkedTimespan({days:[0,2,3,4,5], zones:[0, 13.5*60, 21.5*60, 24*60], type: "dhx_time_block", sections: {timeline:120}});
		//412
		scheduler.addMarkedTimespan({days:[1,2,3,4,6], zones:[0, 15*60, 23*60, 24*60], type: "dhx_time_block", sections: {timeline:130}});
		//413
		scheduler.addMarkedTimespan({days:[0,1,2,3,5], zones:[0, 17*60], type: "dhx_time_block", sections: {timeline:140}});
		//414
		scheduler.addMarkedTimespan({days:[0,1,2,3,5], zones:[6.5*60,22.5*60], type: "dhx_time_block", sections: {timeline:150}});
		scheduler.addMarkedTimespan({days:[3,5], zones:[22.5*60, 24*60], type: "dhx_time_block", sections: {timeline:150}});
		scheduler.addMarkedTimespan({days:[4,6], zones:[0, 22.5*60], type: "dhx_time_block", sections: {timeline:150}});
		
		
		//Sunday
		scheduler.blockTime(0, "fullday", {timeline: [20,50,60,80,90,100,130]});
		//Monday
		scheduler.blockTime(1, "fullday", {timeline: [40,100,120]});
		//Tuesday
		scheduler.blockTime(2, "fullday", {timeline: [40]});
		//Wednesday
		scheduler.blockTime(3, "fullday", {timeline: [70,110]});
		//Thursday
		scheduler.blockTime(4, "fullday", {timeline: [30,110,140]});
		//Friday
		scheduler.blockTime(5, "fullday", {timeline: [30,70,130]});
		//Saturday
		scheduler.blockTime(6, "fullday", {timeline: [20,50,60,80,90,120,140]});
		
		
		
		//init scheduler
		scheduler.init('scheduler_here',new Date(),"timeline");
		//load serverlists
		scheduler.load("codebase/events_tree_db.php");
		
		//connection to DB and init of connection
		var dp = new dataProcessor("codebase/events_tree_db.php");
		dp.enableDebug();
		var currentSkin = 'classic';
		dp.init(scheduler);
	}
	
	
		//show's minical on page
		function show_minical(){
			if (scheduler.isCalendarVisible())
				scheduler.destroyCalendar();
			else
				scheduler.renderCalendar({
					position:"dhx_minical_icon",
					date:scheduler._date,
					navigation:true,
					handler:function(date,calendar){
						scheduler.setCurrentView(date);
						scheduler.destroyCalendar()
					}	
				});
		}
		

	
</script>
</head>
<body onload="init();">
	
	<div id="menuID"></div>
	<div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%; overflow: auto;'>
		<div class="dhx_cal_navline">
			<div class="dhx_cal_prev_button">&nbsp;</div>
			<div class="dhx_cal_next_button">&nbsp;</div>
			<div class="dhx_cal_today_button"></div>
			<div class="dhx_cal_date"></div>
			<div class="dhx_minical_icon" id="dhx_minical_icon" 
				onclick="show_minical()">&nbsp;</div>
		</div>
		<div class="dhx_cal_header">
		</div>
		<div class="dhx_cal_data">
		</div>		
	</div>
	
</body>
<script>
       setInterval(function () {
			if(!scheduler.getState().lightbox_id)
            scheduler.clearAll();
            scheduler.load("codebase/events_tree_db.php");
			//scheduler.updateView();
         }, 10000);
      </script>